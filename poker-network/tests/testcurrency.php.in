<?php // -*- php -*-
// Copyright (C) 2006 Mekensleep
//
// Mekensleep
// 24 rue vieille du temple
// 75004 Paris
//       licensing@mekensleep.com
//
// This program is free software; you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation; either version 2 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program; if not, write to the Free Software
// Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301, USA.
//
// Authors:
//  Loic Dachary <loic@gnu.org>
//

ini_set('include_path', ini_get('include_path') . ":" . "@top_srcdir@/pokerweb/pages");
ini_set('include_path', ini_get('include_path') . ":" . "@top_srcdir@/pokerweb/conf");

require_once 'PHPUnit2/Framework/TestCase.php';

require_once 'currency.php';

$GLOBALS['currency_db_base'] = 'currencytest';

class testcurrency extends PHPUnit2_Framework_TestCase
{
    private $currency;
  
    protected function setUp()
    {
      $c = mysql_connect($GLOBALS['currency_db_host'], $GLOBALS['currency_db_user'], $GLOBALS['currency_db_password']);
      mysql_query("DROP DATABASE IF EXISTS " . $GLOBALS['currency_db_base'], $c);
      mysql_close($c);
      $this->currency = new currency($GLOBALS['currency_db_base'], $GLOBALS['currency_db_user'], $GLOBALS['currency_db_password']);
    }
    
    public function test01_get_note()
    {
      $note = $this->currency->get_note('100');
      $this->assertEquals('http://fake/', $note[0]);
      $this->assertEquals(1, $note[1]);
      $this->assertEquals(40, strlen($note[2]));
      $this->assertEquals('100', $note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($note[2]));
      $this->assertEquals($note, $this->currency->_check_note($note));
      return $note;
    }

    public function test02_change_note()
    {
      $note = $this->test01_get_note();
      $other_note = $this->currency->change_note($note[1], $note[2], $note[3]);
      $this->assertEquals('http://fake/', $note[0]);
      $this->assertEquals(2, $other_note[1]);
      $this->assertEquals(40, strlen($other_note[2]));
      $this->assertNotEquals($note[2], $other_note[2]);
      $this->assertEquals('100', $other_note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($other_note[2]));
      $this->assertEquals($other_note, $this->currency->_check_note($other_note));
      return $other_note;
    }

    public function test03_merge_note()
    {
      $note = $this->test01_get_note();
      $notes = $this->currency->merge_notes_columns(array($note[1]), array($note[2]), array($note[3]));
      $other_note = $notes[0];
      $this->assertEquals('http://fake/', $note[0]);
      $this->assertEquals(2, $other_note[1]);
      $this->assertEquals(40, strlen($other_note[2]));
      $this->assertNotEquals($note[2], $other_note[2]);
      $this->assertEquals('100', $other_note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($other_note[2]));
      $this->assertEquals($other_note, $this->currency->_check_note($other_note));
    }

    public function test03_merge_two_notes()
    {
      $note1 = $this->currency->get_note('100');
      $this->assertEquals(TRUE, $this->currency->commit($note1[2]));
      $note2 = $this->currency->get_note('100');
      $this->assertEquals(TRUE, $this->currency->commit($note2[2]));
      $this->assertNotEquals($note1[2], $note2[2]);
      $notes = $this->currency->merge_notes_columns(array($note1[1], $note2[1]), array($note1[2], $note2[2]), array($note1[3], $note2[3]));
      $this->assertEquals(1, count($notes));
      $other_note = $notes[0];
      $this->assertEquals('http://fake/', $note1[0]);
      $this->assertEquals(1, $other_note[1]);
      $this->assertEquals(40, strlen($other_note[2]));
      $this->assertNotEquals($note1[2], $other_note[2]);
      $this->assertEquals('200', $other_note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($other_note[2]));
      $this->assertEquals($other_note, $this->currency->_check_note($other_note));
    }

    public function test03_merge_change_note()
    {
      $note = $this->test02_change_note();
      $notes = $this->currency->merge_notes_columns(array($note[1]), array($note[2]), array($note[3]));
      $other_note = $notes[0];
      $this->assertEquals('http://fake/', $note[0]);
      $this->assertEquals(3, $other_note[1]);
      $this->assertEquals(40, strlen($other_note[2]));
      $this->assertNotEquals($note[2], $other_note[2]);
      $this->assertEquals('100', $other_note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($other_note[2]));
      $this->assertEquals($other_note, $this->currency->_check_note($other_note));
    }

    public function test04_break_note()
    {
      $note = $this->test01_get_note();
      $notes = $this->currency->break_note($note[1], $note[2], $note[3], array('27', '13', '1'));
      $this->assertEquals(10, count($notes));
      $this->assertEquals('http://fake/', $notes[0][0]);
      $this->assertEquals('27', $notes[2][3]);
      $this->assertEquals('13', $notes[3][3]);
      $this->assertEquals('1', $notes[9][3]);
    }

    public function test04_break_note_incomplete()
    {
      $note = $this->test01_get_note();
      $notes = $this->currency->break_note($note[1], $note[2], $note[3], array('27'));
      $this->assertEquals(4, count($notes));
      $this->assertEquals('http://fake/', $notes[0][0]);
      $this->assertEquals('27', $notes[2][3]);
      $this->assertEquals('19', $notes[3][3]);
    }

    public function test05_put_note()
    {
      $note = $this->test01_get_note();
      $this->currency->put_note($note[1], $note[2], $note[3]);
    }

    public function test06_fail_check_note()
    {
      try {
        $this->currency->check_note(1, 'bugous " name', '10');
      } catch(Exception $error) {
        $this->assertEquals(currency::E_INVALID_NOTE, $error->getCode());
        return;
      }
      $this->fail('should throw an exception');
    }

    public function test07_fail_check_note()
    {
      $note = $this->currency->get_note('100');
      try {
        $other_note = $this->currency->check_note($note[1], $note[2], $note[3]);
      } catch(Exception $error) {
        $this->assertEquals(currency::E_CHECK_NOTE_FAILED, $error->getCode());
        return;
      }
      $this->fail('should throw an exception');
    }

    public function test08_get_big_note()
    {
      $note = $this->currency->get_note('10000000000000');
      $this->assertEquals('http://fake/', $note[0]);
      $this->assertEquals(1, $note[1]);
      $this->assertEquals(40, strlen($note[2]));
      $this->assertEquals('10000000000000', $note[3]);
      $this->assertEquals(TRUE, $this->currency->commit($note[2]));
      $this->assertEquals($note, $this->currency->_check_note($note));
      return $note;
    }

}

//
// Interpreted by emacs
// Local Variables:
// compile-command: "( cd .. ; ./config.status tests/testcurrency.php ) ; ( cd ../tests || cd ../../tests ; make TESTS='testcurrency.php' check )"
// End:
?>
