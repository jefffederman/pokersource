#! /bin/sh
# postinst script for #PACKAGE#
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package
#
. /usr/share/debconf/confmodule
db_version 2.0

get_db_params () {
  db_get "python@PYTHON_VERSION@-poker-network/db/host"
  dbserver="$RET"
  db_get "python@PYTHON_VERSION@-poker-network/db/name"
  dbname="$RET"
  db_get "python@PYTHON_VERSION@-poker-network/db/admin/name"
  dbadmin="$RET"
  db_get "python@PYTHON_VERSION@-poker-network/db/admin/password"
  dbadmpass="$RET"
  db_reset "python@PYTHON_VERSION@-poker-network/db/admin/password"
  db_get "python@PYTHON_VERSION@-poker-network/db/user/name"
  dbuser="$RET"
  db_get "python@PYTHON_VERSION@-poker-network/db/user/password"
  dbpass="$RET"
  db_reset "python@PYTHON_VERSION@-poker-network/db/user/password"
  db_reset "python@PYTHON_VERSION@-poker-network/db/user/password/confirm"
}

pokernetwork_group=pokernetwork
pokernetwork_user=pokernetwork
pokernetwork_dir=/var/lib/pokernetwork

case "$1" in
    configure)
#
# inspired by the mldonkey-server postinst
#
	
	# Creating pokernetwork group if he isn't already there
        if ! getent group $pokernetwork_group > /dev/null ; then
	    addgroup --quiet $pokernetwork_group
	fi
	
        # Creating pokernetwork user if he isn't already there
	if ! getent passwd $pokernetwork_user > /dev/null ; then
	    adduser --quiet --system --ingroup $pokernetwork_group \
		--home $pokernetwork_dir --no-create-home $pokernetwork_user
	fi

	if [ ! -d $pokernetwork_dir ]; then
	    echo -n "Creating pokernetwork home directory : "
	    mkdir $pokernetwork_dir
	    echo "done."
	fi

        if [ "@PYTHON_VERSION@" = "2.3" ] && [ -d /etc/poker-network ] ; then
            /etc/init.d/poker-network stop
            echo "Moving /etc/poker-network to /etc/poker-network2.3"
            update-rc.d -f poker-network remove
            mv /etc/poker-network2.3 /etc/poker-network2.3.old
            mv /etc/poker-network /etc/poker-network2.3
            rm -fr /etc/poker-network2.3.old
            /usr/bin/perl -pi -e 's/\bpoker-(network|engine)\b/$&@PYTHON_VERSION@/g' /etc/poker-network2.3/*.xml
        fi

        /usr/sbin/pokerconfigupgrade@PYTHON_VERSION@ --verbose=1 --module=pokernetwork.pokernetworkconfig --reference=/usr/share/poker-network@PYTHON_VERSION@/conf /etc/poker-network@PYTHON_VERSION@ 
	for file in bot client server ; do
            /usr/sbin/pokerconfigupgrade@PYTHON_VERSION@ --verbose=1 --module=pokernetwork.pokernetworkconfig --upgrades=/usr/share/poker-network@PYTHON_VERSION@/upgrades/poker.$file /etc/poker-network@PYTHON_VERSION@/poker.$file.xml
	done

        db_get "python@PYTHON_VERSION@-poker-network/host"
        poker_network_host="$RET"

	db_get "python@PYTHON_VERSION@-poker-network/skip"
        tmpfile=`mktemp`
	if [ $RET = "false" ]; then
	    touch /etc/poker-network@PYTHON_VERSION@/lockfile
	else
	    get_db_params
	    . /usr/share/wwwconfig-common/mysql-createdb.sh
	    . /usr/share/wwwconfig-common/mysql-createuser.sh
	    . /usr/share/wwwconfig-common/mysql.get

	    sed -e "s/\%PASS\%/$dbpass/" -e "s/\%DBHOST\%/$dbserver/" -e "s/\%USER\%/$dbuser/" -e "s/\%DATABASE\%/$dbname/" /etc/poker-network@PYTHON_VERSION@/poker.server.xml > $tmpfile
            if diff $tmpfile /etc/poker-network@PYTHON_VERSION@/poker.server.xml > /dev/null
            then
                rm $tmpfile
            else
                mv  $tmpfile /etc/poker-network@PYTHON_VERSION@/poker.server.xml
                chmod 600 /etc/poker-network@PYTHON_VERSION@/poker.server.xml
            fi

 	    if ! eval $mysqlcmd -h "$dbserver" -f -e "\"use $dbname; show tables;\"" | grep -e "user2table" > /dev/null 2>&1 ; then
 		$mysqlcmd  -h "$dbserver" --password="$dbpass" -u $dbuser $dbname < /usr/share/poker-network@PYTHON_VERSION@/schema.sql
            else
                /usr/sbin/pokerdatabaseupgrade@PYTHON_VERSION@ /etc/poker-network@PYTHON_VERSION@/poker.server.xml
 	    fi
            rm -f /etc/poker-network@PYTHON_VERSION@/lockfile
	fi

        for conf_file in /etc/poker-network@PYTHON_VERSION@/poker.client.xml /etc/poker-network@PYTHON_VERSION@/poker.bot.xml ; do
            if grep '%HOST%' $conf_file > /dev/null ; then
                sed -e "s/\%HOST\%/$poker_network_host/" $conf_file > $tmpfile
                mv $tmpfile $conf_file
                chmod 644 $conf_file
            fi
        done

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)

    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

db_stop

exit 0


