MKDIR	= @MKDIR@
RM	= @RM@
JAVA	= @JAVA@
JAVAC	= @JAVAC@
JAVAH	= @JAVAH@
JAVADOC	= @JAVADOC@
JAR	= @JAR@
JDKHOME	= $(dir $(JAVAH))/..
SLIB_CMD= @SLIB_CMD@

JAVADOCDIR	:= javadoc
SRC_JAVA 	:= $(shell find org -name '*.java')
ALL_PKGS        := $(sort $(dir $(SRC_JAVA)))
ALL_PKGS        := $(patsubst %/,%, $(ALL_PKGS))
ALL_PKGS        := $(subst /,., $(ALL_PKGS))
JAVADOC_PKGS	:= $(filter-out %.test, $(ALL_PKGS))
CLASSFILES	:= $(SRC_JAVA:.java=.class)

JNI_JAVA	:= org/pokersource/eval/StandardEval.java \
		   org/pokersource/eval/JokerEval.java \
		   org/pokersource/eval/AsianStudEval.java \
		   org/pokersource/enum/Enumerate.java
JNI_CLASSES	:= $(subst /,., $(JNI_JAVA:.java=))
JNI_CLASSFILES	:= $(JNI_JAVA:.java=.class)
JNI_OBJS	:= $(JNI_JAVA:.java=Imp.o)
JNI_OBJS	+= jniutil.o pokutil.o
JNI_HEADER	:= pokerjni.h
JNILIB		:= libpokerjni@SO@
JNI_INCLUDES	:= $(addprefix -I, $(shell find $(JDKHOME)/include -type d))
JARFILE		:= pokersource.jar

all: classes jnilib jarfile javadoc
classes: $(CLASSFILES)
jnilib: $(JNILIB)
jarfile: $(JARFILE)
javadoc: $(JAVADOCDIR)/index.html

$(JARFILE): $(CLASSFILES)
	$(JAR) cf $@ $^

$(JAVADOCDIR)/index.html: $(SRC_JAVA)
	[ -d $(JAVADOCDIR) ] || $(MKDIR) $(JAVADOCDIR)
	$(JAVADOC) -d $(JAVADOCDIR) -private -classpath $(CLASSPATH) $(JAVADOC_PKGS)

clean: cleanclass
	$(RM) $(JNI_HEADER) $(JNI_OBJS) $(JNILIB)
	$(RM) -r $(JAVADOCDIR)
cleanclass:
	$(RM) $(CLASSFILES)

%.class: %.java
	$(JAVAC) -classpath $(CLASSPATH) $<

pokerjni.h: $(JNI_CLASSFILES)
	$(JAVAH) -o $@ -jni -force $(JNI_CLASSES)

.c@O@:
	$(CC) $(CFLAGS) -I. -I../include $(JNI_INCLUDES) -c $< -o $@

# should fix hardcoded SLIB_CMD
$(JNILIB): $(JNI_OBJS)
	$(SLIB_CMD) -L../lib -lpoker

$(JNI_OBJS): $(JNI_HEADER)

test: $(CLASSFILES)
	java org.pokersource.AllTests

develtest: $(CLASSFILES)
	java org.pokersource.eval.StandardEval
	java org.pokersource.eval.JokerEval
	java org.pokersource.eval.AsianStudEval
	java org.pokersource.enum.Enumerate
	java org.pokersource.enum.HoldemAtomicGroup AhQh
	java org.pokersource.enum.HoldemCanonGroup AA
	java org.pokersource.enum.HoldemCanonGroup KQs
	java org.pokersource.enum.HoldemCanonGroup T9
	java org.pokersource.enum.HoldemSMGroup SM2
	java org.pokersource.enum.HoldemUniversalGroup
	java org.pokersource.enum.HoldemBeliefVector "AhKh" "AA KK:50 QQ:20"
	java org.pokersource.enum.SAIE "AhKh" "AKs" "4h 5h 6h" ""
	java org.pokersource.enum.SAIE "87s+" "77" "7h 6h 5h" ""
	java org.pokersource.enum.SAIE "KhQc" "SM1 SM2 SM3" "4h 5h 3d" ""
	java org.pokersource.enum.SAIE "KhQc" "SM1 SM2 SM3 SM4 SM5" "4h 5h 3d" ""
	java org.pokersource.enum.SAIE "KhQc" "<any>" "4h 5h 3d" ""

Makefile: Makefile.in
.PHONY: javadoc
