<?xml version="1.0" encoding="utf-8"?>
<!--
////////////////////////////////////////////////////////////////////////////////
//
//     Copyright (C) 2008 Bruno Garnier <bruno.garnier@gmail.com>
//
//     This program is free software: you can redistribute it and/or modify
//     it under the terms of the GNU General Public License as published by
//     the Free Software Foundation, either version 3 of the License, or
//     (at your option) any later version.
//
//     This program is distributed in the hope that it will be useful,
//     but WITHOUT ANY WARRANTY; without even the implied warranty of
//     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
//     GNU General Public License for more details.
//
//     You should have received a copy of the GNU General Public License
//     along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
////////////////////////////////////////////////////////////////////////////////
-->

<mx:Canvas xmlns:mx="http://www.adobe.com/2006/mxml" width="100%" 
	xmlns:component="aspoker.com.bubsy.poker.client.component.*" 
	creationComplete="_init()" remove="_destroy();">
	
	  <mx:Script>
 	<![CDATA[
 		import mx.core.Container;
 		import aspoker.com.bubsy.poker.client.PokerClient;
 		import mx.core.Application;
 		import aspoker.com.bubsy.poker.client.model.Table;
		import aspoker.com.bubsy.poker.client.event.TableEvent;
		
		public var table:Table;
		
		public function set gameId(gameId:int):void
		{
			table = new Table(gameId);
			
			table.addEventListener(
				TableEvent.onPacketPokerPlayerArrive,
				onPlayerArrive
			);
			
			table.addEventListener(
				TableEvent.onPacketPokerPlayerLeave,
				onPlayerLeave
			);
		}
		
		private function _init():void
		{
			setSeat();
			table.join(table.gameId);
		}
		
		private function _destroy():void
		{
			table.removeEventListener(
				TableEvent.onPacketPokerPlayerArrive,
				onPlayerArrive);
				
			table.removeEventListener(
				TableEvent.onPacketPokerPlayerLeave,
				onPlayerLeave
			);
			
			table.destroy();
			table = null;
		}
		
		private function quit():void
		{
			var container:Container = Application.application.myViewStack;
			this.removeAllChildren();
			parent.removeChild(this);
		}
		
		private function setSeat():void
 		{
 			for each (var item:CSeat in seats.getChildren()) 
 			{
				item.table = table;
				item.gameId = table.gameId;
			}
 		}
 		
 		public function onPlayerLeave(evt:TableEvent):void
 		{
 						
 			if (!evt.packet || 
 				(evt.packet.serial == PokerClient.user.userSerial)
 			)
 			{
 				 quit();
 			} else {
 				var cseat:CSeat= seats.getChildByName(
				"seat"+evt.packet.seat
				) as CSeat ;
				
				cseat.currentState = "free";
				cseat = null;
 			}
 		}
 		 		
 		public function onSeat(evt:TableEvent):void
 		{
 			var i:int=0;
			for each (var seat:int in table.seats)
			{
				if(seat>0) {
					var cseat:CSeat= seats.getChildByName("seat"+i) as CSeat ;

					cseat.currentState = "used";
					cseat = null;
				}
				i++;
			}
 		}
		
		public function onPlayerArrive(evt:TableEvent):void
 		{
			var cseat:CSeat= seats.getChildByName(
				"seat"+evt.packet.seat
				) as CSeat ;
				
			cseat.currentState = "used";
			cseat = null;
 		}
 		
 		public function onSitOut(evt:TableEvent):void
 		{
 			for each (var item:CSeat in seats.getChildren()) 
 			{
    			if (evt.packet.seat != item.seatId 
    				&& item.currentState=='disabled'
    			)
    			{
    				item.currentState= 'free';
    			}
			}
 		}
 		
 	 ]]>
 	</mx:Script>
 	
	<mx:VBox>
			<mx:Canvas id="seats" name="seats" >
				<component:CSeat 
					id="seat1" 
					name="seat1"
					seatId="1" 
					left="0"/>
				
				<component:CSeat 
					id="seat2" 
					seatId="2" 
					name="seat2"
					left="150"/>
				
				<component:CSeat 
					id="seat3" 
					name="seat3"
					seatId="3" 
					left="300"/>
				
				<component:CSeat 
					id="seat4" 
					seatId="4" 
					name="seat4"
					left="450"/>
				
				<component:CSeat 
					id="seat5" 
					seatId="5" 
					name="seat5"
					left="600"
					/>
					
				<component:CSeat 
					id="seat6" 
					seatId="6" 
					name="seat6"
					left="0" 
					top="200" />
					
				<component:CSeat 
					id="seat7" 
					seatId="7" 
					name="seat7"
					left="150"
					top="200"/>
					
				<component:CSeat 
					id="seat8" 
					seatId="8" 
					name="seat8"
					left="300"
					top="200"/>
					
				<component:CSeat 
					id="seat9" 
					seatId="9" 
					name="seat9"
					left="450"
					top="200"/>
					
				<component:CSeat 
					id="seat0" 
					seatId="0" 
					name="seat0"
					left="600"
					top="200"/>
			</mx:Canvas>
			
			<mx:HBox>
				<mx:Button label="fold" />
				<mx:Button label="check" />
				<mx:Button label="call" />
				<mx:Button label="raise" />
				<mx:Button label="rebuy" click="table.buyIn()" />
				<mx:Button label="sit out" />
				<mx:Button label="sit" />
				<mx:Button label="exit"  click="table.quit()"/>
			</mx:HBox>
	</mx:VBox>		
</mx:Canvas>
